{% extends 'app_fb_questionnaire/base.html' %} {% block content %}

<form id="form-question" method="POST" action="{% url 'questionnaire-save' %}">
  {% csrf_token %}

  <input type="hidden" name="question_set_id" value="{{ question_set_id }}" />
  <input type="hidden" name="fb_user_id" id="fb_user_id" value="" />
  <input type="hidden" name="fb_user_name" id="fb_user_name" value="" />
  <input type="hidden" name="ref_fb_user_id" id="ref_fb_user_id" value="{{ fb_user_id }}" />

  <h3>Questionnaire</h3>

  {% for obj in qs %}

    <label class="form-control-label" for="formGroupExampleInput">{{ forloop.counter }}.{{ obj.question }}</label> 

    {% for c in obj.choices %}
    <div class="form-check">
      <label class="form-check-label">
        <input class="form-check-input" type="radio" name="choice_{{ obj.question_set_item_id }}" value="{{ c.question_choice_id }}" required>
          {{ c.question_choice_name }}
      </label>
    </div>    
    {% endfor %} 

    <hr />

  {% endfor %}  

</form>

<div class="fb-login-button" scope="public_profile,email" onlogin="checkLoginState();" data-max-rows="1" data-size="medium"
      data-button-type="continue_with" data-show-faces="false" data-auto-logout-link="false" data-use-continue-as="true"></div>

{% endblock %} 

{% block scripts %}

<script>
  
  window.onload = function(evt) {  
    $(".fb-login-button").hide();  
    checkFBLoginButton();
  }

  onFormWatch();
  
  function onFormWatch() {
    
    $("#form-question").change(function() {

      checkFBLoginButton();
      
    });
  }

  function checkFBLoginButton() {
    var isValid = document.getElementById('form-question').checkValidity();
    if (isValid === true) {
      // Show FB login button
      $(".fb-login-button").show(500);
    }
  }

  function checkLoginState() {
    FB.getLoginStatus(function (response) {
      statusChangeCallback(response);
    });
  }

  function statusChangeCallback(response) {
    if (response.status === 'connected') {
      // Logged into your app and Facebook.   
      getUserProfile()
      // Submit form
      
    } else {
      alert("Not log in")
    }
  }

  function getUserProfile() {
    FB.api(`/me`, {
      fields: "email,picture,age_range,cover,devices,gender,first_name,last_name,middle_name,name,meeting_for,political,relationship_status,timezone,link,locale,location,languages"
    }, function (res) {
      console.log("RES:", res);
      $('#fb_user_id').attr('value', res.id)
      $('#fb_user_name').attr('value', res.name)
      $('#form-question').submit()
    });
  }

  function fbLogout() {
    FB.logout(function (response) {
      // Person is now logged out
      window.location = "/"
    });
  }
</script>
{% endblock %}